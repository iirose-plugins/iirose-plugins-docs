# 媒体相关报文

本文档详细说明了与 IIROSE 平台内媒体消息发送、媒体播放控制及信息获取相关的报文格式和交互逻辑。

## 媒体消息

通过在消息中嵌入特定格式的 URL，可以发送图片、语音和视频。

### 发送图片

> 图片可以直接使用 `URL`，或使用 `URL#e`、`[URL]`、`[URL#e]` 的格式。

#### 发送格式
```log
{"m":"http://r.iirose.com/i/25/10/6/2/2917-4W.png#e","mc":"614530","i":"703027225044"}
```

#### 接收格式
```log
"1762414470>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>http://r.iirose.com/i/25/10/6/2/2917-4W.png#e>614530>614530>2>>679a51f1d4893>''1867'57'2,100,0.5>703027225044
```

### 发送语音

:::warning
语音 URL 必须以 `.weba` 结尾。
:::

#### 发送格式
```log
{"m":"http://r.iirose.com/s/25/11/6/15/3556-OL.weba","mc":"614530","i":"554554093356"}
```

#### 接收格式
```log
"1762414555>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>http://r.iirose.com/s/25/11/6/15/3556-OL.weba>614530>614530>2>>679a51f1d4893>''1867'57'2,100,0.5>554554093356
```

### 发送视频

:::warning
视频 URL 需要用 `[]` 包裹。
:::

#### 发送格式
```log
{"m":"[http://r.iirose.com/m/25/11/1/17/0614-1U.mp4]","mc":"614530","i":"185967768146"}
```

#### 接收格式
```log
"1762414618>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>[http://r.iirose.com/m/25/11/1/17/0614-1U.mp4]>614530>614530>2>>679a51f1d4893>''1867'57'2,100,0.5>185967768146
```

## 房间媒体播放

### 点播媒体

点播媒体分为两个阶段：用户发送 **点播卡片**，以及服务器在播放时推送 **媒体播放更新** 事件。

#### 点播卡片

> 用户消息

当用户成功点播一首歌曲或一个视频时，客户端会自动发送一条点播卡片消息到公屏。

- **报文流向**: 客户端 `->` 服务器 (发送) / 服务器 `->` 客户端 (接收)

##### 发送格式
```log
{"m":"m__4@0>ninelie>Aimer  &  EGOIST>http://p2.music.126.net/g7aakYG_Wfmrn1_IDfVUXA==/109951165050166241.jpg>001826>128","mc":"001826","i":"688829143194"}
```

##### 接收格式
```log
"1762614068>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>m__4@0>ninelie>Aimer  &amp;  EGOIST>http://p2.music.126.net/g7aakYG_Wfmrn1_IDfVUXA==/109951165050166241.jpg>001826>128>001826>614530>2>>679a51f1d4893>''1909'60'2,100,0.5>688829143194
```

#### 媒体播放更新

> 服务器事件

当房间的媒体播放列表或当前播放状态发生变化时（如开始播放新内容），服务器会主动推送此事件。

- **报文流向**: 服务器 `->` 客户端 (接收)
- **报文标识**: `&1`

##### 接收格式
```log
&1://m10.music.126.net/20251108232211/765b9c3b34bb27f3425b3e118b43f3f6/ymusic/obj/w5zDlMODwrDDiGjCn8Ky/2134076537/afc7/9e57/60e5/0b4uZGFyZA#163=1439814454 s://music.163.com/#/song?id=1439814454>225.817333>我的悲伤是水做的>@0ChiliChill  &  洛天依Official>上学>2>://p2.music.126.net/JyF6_2QvPlLSuXSgYDwi0Q==/109951164896130416.jpg>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>>[00:00.000] 作词 : ChiliChill
[00:01.000] 作曲 : ChiliChill
...
[03:11.353]晒干这一片蓝色
```

### 播放控制

#### 切歌

请求立即播放列表中的下一个媒体。

- **报文流向**: 客户端 `->` 服务器
- **发送内容**: 在聊天框输入 `cut` 并发送。

##### 发送格式
```log
{"m":"cut","mc":"614530","i":"503348881473"}
```

##### 响应格式
- **成功终止**:
  ```log
  ,
  ```
- **发起切歌投票** (如：1 / 3 票):
  ```log
  _~M01
  ```
- **已经投过票**:
  ```log
  _~G1
  ```
- **当前无播放**:
  ```log
  _~P
  ```

:::tip
如果用户切的是自己点播的内容，则无需投票，会直接终止。
:::

#### 清空播放列表

请求清空房间内整个媒体播放列表。

- **报文流向**: 客户端 `->` 服务器
- **发送内容**: 在聊天框输入 `cut all` 并发送。

##### 发送格式
```log
{"m":"cut all","mc":"d28ad2","i":"424754827366"}
```

##### 响应格式
- **发起清空投票** (如：1 / 3 票):
  ```log
  _~M11
  ```
- **已经投过票**:
  ```log
  _~G1
  ```
- **当前无播放**:
  ```log
  _~P
  ```

### 获取播放列表

- **请求指令**:
  ```log
  %
  ```
- **响应格式 (列表为空)**:
  ```log
  ~
  ```
- **响应格式 (列表非空)**:
  ```log
  ~213.831111>藤あや子-素颜（MyGO二创版（玉米 remix）"@0玉米>614530上学>2>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>://p2.music.126.net/QSXY93X7PdY1dglTTB92gQ==/109951170127758670.jpg<225.817333>我的悲伤是水做的"@0ChiliChill  &  洛天依Official>614530上学>2>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>://p2.music.126.net/JyF6_2QvPlLSuXSgYDwi0Q==/109951164896130416.jpg