# 登录后初始数据包解析

在客户端成功登录后，IIROSE 服务器会立即下发一个 **体积非常庞大** 的 **初始数据包** 。

在登陆成功之后，IIROSE 仍然会定时向全服用户广播类似的大包，以保证数据的定时更新。

:::warning
注意：下文的示例报文 均**添加了换行符**以便理解

实际报文**一般**是没有这些换行符的
:::

## 1. 整体结构：多级分隔符系统

这个数据包采用了 **多级分隔符** 来组织数据。

- **`%`**: 标志着整个数据包的开始。
- **`"` (双引号)**: **最高层级**的分隔符。它将整个报文精确地分割成 **主要部分**。
- **`<`**: **第二层级**的分隔符。在每个主要部分内部，用于分隔单个数据对象（例如一个用户、一个频道）。
- **`>`**: **第三层级**的分隔符。在每个数据对象内部，用于分隔该对象的具体属性字段。

### 四个主要部分

整个大包由 `"` 分隔为以下几个连续的数据块：

-  **前缀部分**: 歌单数据、股价数据（**一般情况下** 登陆成功的大包里 **不会下发**，但是全服定时大包里会收到。）
-  **第一部分**: 用户列表、频道列表
-  **第二部分**: 频道历史消息列表
-  **第三部分**: 登录加载页面所需的数据

#### 示例报文
```log
% 
*  //  前缀部分（这里如果没有歌单数据，就是`*`，反之则是歌单内容）
"4770095.648 1907.9182886849#1051$1432.2229687257 //  前缀部分（这是银行、股价信息）

"用户头像>性别>名称>气泡颜色>uid>n>>>uid>>...省略 //  第一部分（用户、频道列表）

<用户头像>性别>名称>气泡颜色>uid>n>>>uid>>...省略

<房间地址>名称>>000>>简介>...省略

<房间地址>名称>>000>>简介>...省略

"用户名称>性别>气泡颜色>头像>>>uid>uid>>>...省略   //  第二部分（个人信息+频道历史记录）
<数字>头像>名称>'3>s>000000>2>背景图>uid>签名...省略

<数字>头像>名称>'3>s>000000>2>背景图>uid>签名...省略

">>00   //  第三部分
<>&>20>>10,0>0>>进入房间的加载过程图片>>
```

## 2. 第一部分（1）：用户列表

这是由第一个 `"` 分隔出的数据块，包含了大量的用户信息。

### 对象结构

每个用户对象由 `<` 开始，内部由 `>` 分隔字段。

#### 字段解析 (示例)
```log
<cartoon/600264
>2
>anata baka？
>d28ad2
>5ce6a4b520a90
>n
>
>
>68af217fea585
>
>
>*
>
>41
>3
>0,0,0.5
```
| 索引 | 可能的含义 |
| :--- | :--------- |
| 0    | 头像       |
| 2    | 用户名     |
| 3    | 颜色       |
| 4    | 房间ID     |
| 8    | 用户UID    |
| ...  | ...        |

:::tip
部分用户为 **默认头像**，格式为 `cartoon/602178` 

需要拼接为完整URL： `http://s.iirose.com/images/icon/${avatar}.jpg`

即 http://s.iirose.com/images/icon/cartoon/602178.jpg


**注意使用HTTP，而不是HTTPS**
:::

## 3. 第一部分（2）：频道列表

包含了所有频道（房间分区）的信息。

:::tip
可以用第一个字段内容是否包含 `/` 来判断是 频道数据 还是 用户数据。

> 因为用户头像会包含 `/` 来表示路径，
> 
> 房间则是`固定长度的数字+字母`的组合，并且会使用 `_` 标识层级结构。
:::

### 对象结构

每个频道对象由 `<` 开始，内部由 `>` 分隔字段。

#### 字段解析 (示例)
```log
<5b792cb650749_61b25bb771a6b_690f3ff5c86e3
>，，，
>0,0,0
>2003
>
> &&忽来&&0&&cartoon/602226&&&&&&&&
>1,1762607093
>
```
| 索引 | 可能的含义     |
| :--- | :------------- |
| 0    | 频道ID         |
| 1    | 频道名         |
| 5    | 频道背景与简介 |


## 4. 第二部分：频道历史消息

1. 个人信息：首行内容为个人信息，与`第一部分（1）`内容包含的个人的信息一致，所以一般不走这里获取。

2. 历史记录：一般情况，应该忽略此部分内容。

    BOT只需要关注上线后的消息即可，无需响应历史消息。

## 5. 第三部分：加载页面数据

用于渲染客户端的进入房间的加载页面。

### 对象结构

这部分数据同样由 `<` 和 `>` 分隔。

#### 字段解析 (示例)
```log
<
>&
>20
>
>10,0
>0
>
>://r.iirose.com/i/22/5/12/8/5051-G5.jpg
>
>
```
| 索引 | 可能的含义          |
| :--- | :------------------ |
| 7    | 加载页面的背景图URL |


## 完整示例报文（1）

完整文件请前往 -> [点我查看完整报文（1）](././../../../public/assets/iirose/dev/after-login/after-login-1.txt)

```log
%*

"

"

//  下面是用户列表
"http://r.iirose.com/i/25/8/15/2/1414-V8.gif>4>莲子心‎>6b4d44>62b2e24d2956f>n>>>668fae7670d88>>>4>>172>34>1,100,0.5
<http://r.iirose.com/i/25/10/7/18/2002-N9.png>0>纸片人>7ea0c8>65b3c5cc101fd>n>>>5e4fff2d0a992>5>http://r.iirose.com/i/20/1/2/5/5614-5G.jpg>>0向划过黑夜的流星许下心愿☄️>18609>2009>15,100,0.5
<cartoon/602178>2>小学>da9f9a>5fdcb9b634621>d>Bot of Koishi~\nPowered by IIROSE Adapter.>>679a67a46f713>>>a>4>2439>2>2,100,0.5'5b792977089e7>社区>32,32,32>000>>://r.iirose.com/i/21/5/21/20/3310-GX.jpg 为您提供各类系统服务&&IIROSE&&0&&system/900003&&1IMod&&&&&&>1,1536146146>1


//  下面是频道列表
<5b792c73178f2>住宅>32,32,32>000>>://r.iirose.com/i/21/5/21/20/3539-BG.jpg 对住宅区房产持有超过2栋的人征收物管费 , 收费标准为阶梯式 :\n  小于等于2栋 : 免物管费\n  大2栋 : 超过部分收取物管费 ,  超过一栋 8钞/日 , 超过两栋 10钞/日 , 超过三栋 12钞/日 , 假如我有5栋房计算方法为 : 超过部分为3栋,故此,8+10+12,也就是 30钞/日&&IIROSE&&0&&system/900003&&1IMod&&&&&&>1,1536146147>1
<5b792cb650749_690cc460936d3>君凌橙夏>0,0,0>2003>> &&君凌&&1&&http://r.iirose.com/i/25/10/19/12/4016-KC.jpg&&&&&&&&>1,1762444384>
<5b792cb650749_690eb5971454e>此世.彼世>0,0,0>0003>>://r.iirose.com/i/25/11/8/6/1212-PG.png &&无北先生&&0&&http://r.iirose.com/i/25/10/23/15/5042-X5.png&&&&&&&&>1,1762571671>
<5b792cb650749_690f30bc3d1d3>一日间>0,0,0>2003>2>://r.iirose.com/i/25/11/8/20/0333-7M.png &&Phosphophyllite&&0&&http://r.iirose.com/i/25/2/24/14/2941-GD.png&&1远浪&&&&&&>1,1762603196>
<5b792cb650749_61b25bb771a6b_690f3ff5c86e3>，，，>0,0,0>2003>> &&忽来&&0&&cartoon/602226&&&&&&&&>1,1762607093>

//  可能是个人信息
"小学>2>da9f9a>cartoon/602178>>>679a67a46f713>67adce1c79a05>>4>

//  下面是历史聊天记录
"1762610384>cartoon/602178>小学>'3>s>da9f9a>2>>679a67a46f713>4''2439'2'2,100,0.5>>2
<1762609577>cartoon/602178>小学>'1>s>da9f9a>2>>679a67a46f713>4''2438'2'2,100,0.5>>15fdcb9b634621'd'Bot of Koishi~\nPowered by IIROSE Adapter.'''
<1762608775>cartoon/602178>小学>'3>s>da9f9a>2>>679a67a46f713>4''2438'2'2,100,0.5>>2
<1762607291>cartoon/602178>小学>啊呜， [*上学*] 下次再来哦~>ffffff>da9f9a>2>>679a67a46f713>4''2438'2'2,100,0.5>978519260699
<1762607281>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>'3>s>614530>2>>679a51f1d4893>''1908'60'2,100,0.5>>2
<1762605357>cartoon/602178>小学>'1>s>da9f9a>2>>679a67a46f713>4''2437'2'2,100,0.5>>15fdcb9b634621'd'Bot of Koishi~\nPowered by IIROSE Adapter.'''

//  下面是加载信息
">>00 
<>&>10>>10,0>2>>>>
```

## 完整示例报文（2）

:::warning
特殊的，当前房间如果存在播放歌单，则会在登录大包头部下发歌单数据。

这与之后的 [媒体播放更新](./media.md#媒体播放更新) 头部特征字符串不一致。
:::

完整文件请前往 -> [点我查看完整报文（2）](././../../../public/assets/iirose/dev/after-login/after-login-2.txt)


```log
%1://m801.music.126.net/obj/76312695430.mp3?GFyZA#163=3315970981 s://music.163.com/#/song?id=3315970981>206>蝉鸣语>@0洛天依  &amp;  无铭07号机>上学>2>://p1.music.126.net/V5o2dT1xiUyaQliq8PMkRg==/109951172254423143.jpg>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>191>[00:00.000] 作词 : 欧阳珏茉\n[03:10.080]雷雨与风霜都再也无法让我停止歌唱\n[03:15.810]唱一只蝉的美梦\n[03:18.060]在这夏夜之中\n

"


"http://r.iirose.com/i/23/10/17/14/1956-3T.jpg>1>小行星序列号134340>fcfcfc>6030fe8270c07>e>为了您的身心健康，请勿靠近。>>652e24fa4babe>>>>>7063>0>2,100,0.5


//  下面是与 `完整示例报文（1）` 一致
"http://r.iirose.com/i/25/8/15/2/1414-V8.gif>4>莲子心‎>6b4d44>62b2e24d2956f>n>>>668fae7670d88>>>4>>172>34>1,100,0.5
<http://r.iirose.com/i/25/10/7/18/2002-N9.png>0>纸片人>7ea0c8>65b3c5cc101fd>n>>>5e4fff2d0a992>5>http://r.iirose.com/i/20/1/2/5/5614-5G.jpg>>0向划过黑夜的流星许下心愿☄️>18609>2009>15,100,0.5
...
...
...
```


## 完整示例报文（3）

:::warning
特殊的，大包会**定时全服广播**下发。

这与此前的登录大包有部分数据不一致：

- 头部添加了银行、股价数据。

- 只有用户列表。
:::

完整文件请前往 -> [点我查看完整报文（3）](././../../../public/assets/iirose/dev/after-login/after-login-3.txt)

```log
%*

"

"4765802.379 603.1949432894#1000$1000

"http://r.iirose.com/i/23/10/17/14/1956-3T.jpg>1>小行星序列号134340>fcfcfc>6030fe8270c07>e>为了您的身心健康，请勿靠近。>>652e24fa4babe>>>>>7063>0>2,100,0.5
<http://r.iirose.com/i/21/10/30/21/5231-2X.png>1>Haise>646364>68fd67c8691c8>n>>>5ffabfcccfa33>>>>0❄️镜面之波❄️>9857>364>63,43.1,0.38
<https://i.postimg.cc/BStWzkyp/1745567666061.jpg>4>失眠的米小璐>ffffff>67f64f70a94ae>n>>>62a4a75d45d60>>>9>>2493>472>32,96.5,0.98
<http://r.iirose.com/i/25/11/9/1/4444-WS.jpg>4>荔枝>6792ba>5b9baf7018864>n>>>68467c6e1c604>1>>*>>261>106>4,100,0.5
<http://r.iirose.com/i/25/11/1/16/4914-GR.jpg>2>高松灯>df89cb>67f64f70a94ae>e>我剑🗡️...也未尝不利！>>674fdc37b4a93>5>http://r.iirose.com/i/25/9/7/16/1908-XW.png>*>0故事的结局配不上过程>6367>3414>83,96.4,1.46'
```