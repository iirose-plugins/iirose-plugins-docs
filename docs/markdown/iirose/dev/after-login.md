# 登录后初始数据包解析

在客户端成功登录后，IIROSE 服务器会立即下发一个 **体积非常庞大** 的 **初始数据包** 。

在登陆成功之后，IIROSE 仍然会定时向全服用户广播类似的大包，以保证数据的定时更新。

:::warning
注意：下文的示例报文 均**添加了换行符**以便理解

实际报文**一般**是没有这些换行符的
:::

## 1. 整体结构：多级分隔符系统

这个数据包采用了 **多级分隔符** 来组织数据。

- **`%*`**: 标志着整个数据包的开始。
- **`"` (双引号)**: **最高层级**的分隔符。它将整个报文精确地分割成 **主要部分**。
- **`<`**: **第二层级**的分隔符。在每个主要部分内部，用于分隔单个数据对象（例如一个用户、一个频道）。
- **`>`**: **第三层级**的分隔符。在每个数据对象内部，用于分隔该对象的具体属性字段。

### 四个主要部分

整个大包由 `"` 分隔为以下几个连续的数据块：

-  **前缀部分**: 股价数据、歌单数据
-  **第一部分**: 用户列表、频道列表
-  **第二部分**: 频道历史消息列表
-  **第三部分**: 登录加载页面所需的数据

#### 示例报文
```log
%*  //  开始标记
"  //  前缀部分（歌单数据）
"4770095.648 1907.9182886849#1051$1432.2229687257 //  前缀部分（银行、股价信息）//  一般登陆成功的大包里不会下发这个

"用户头像>性别>名称>气泡颜色>uid>n>>>uid>>...省略 //  第一部分

<用户头像>性别>名称>气泡颜色>uid>n>>>uid>>...省略

<房间地址>名称>>000>>简介>...省略

<房间地址>名称>>000>>简介>...省略

"用户名称>性别>气泡颜色>头像>>>uid>uid>>>...省略   //  第二部分
<数字>头像>名称>'3>s>000000>2>背景图>uid>签名...省略

<数字>头像>名称>'3>s>000000>2>背景图>uid>签名...省略

">>00   //  第三部分
<>&>20>>10,0>0>>进入房间的加载过程图片>>
```

## 2. 第一部分 - 1：用户列表

这是由第一个 `"` 分隔出的数据块，包含了大量的用户信息。

### 对象结构

每个用户对象由 `<` 开始，内部由 `>` 分隔字段。

#### 字段解析 (示例)
```log
<cartoon/600264
>2
>anata baka？
>d28ad2
>5ce6a4b520a90
>n
>
>
>68af217fea585
>
>
>*
>
>41
>3
>0,0,0.5
```
| 索引 | 可能的含义 |
| :--- | :--------- |
| 0    | 头像       |
| 2    | 用户名     |
| 3    | 颜色       |
| 4    | 房间ID     |
| 8    | 用户UID    |
| ...  | ...        |


## 3. 第一部分 - 2：频道列表

包含了所有频道（房间分区）的信息。

### 对象结构

每个频道对象由 `<` 开始，内部由 `>` 分隔字段。

#### 字段解析 (示例)
```log
<5b792c73178f2
>住宅
>32,32,32
>000
>
>://r.iirose.com/i/21/5/21/20/3539-BG.jpg 对住宅区房产...
>1,1536146147
>1
```
| 索引 | 可能的含义     |
| :--- | :------------- |
| 0    | 频道ID         |
| 1    | 频道名         |
| 5    | 频道背景与简介 |


## 4. 第二部分：个人信息

与第一部分的用户数据处理方法一致。

此内容可以用于更新机器人自身数据，

当然也可以从第一部分的 `用户列表` 里找到机器人数据。

## 5. 第三部分：加载页面数据

用于渲染客户端的进入房间的加载页面。

### 对象结构

这部分数据同样由 `<` 和 `>` 分隔。

#### 字段解析 (示例)
```log
<
>&
>20
>
>10,0
>0
>
>://r.iirose.com/i/22/5/12/8/5051-G5.jpg
>
>
```
| 索引 | 可能的含义          |
| :--- | :------------------ |
| 7    | 加载页面的背景图URL |


## 完整示例报文

> 这里是适配器的日志打印示例
>
> 所以其中会看到外围有`"`包裹起来
> 并且内部的`"`变为了`\"`
>
> 你需要根据实际返回的内容进行处理
```log
"%*

//  下面是用户列表
\"http://r.iirose.com/i/25/8/15/2/1414-V8.gif>4>莲子心‎>6b4d44>62b2e24d2956f>n>>>668fae7670d88>>>4>>172>34>1,100,0.5
<http://r.iirose.com/i/25/10/7/18/2002-N9.png>0>纸片人>7ea0c8>65b3c5cc101fd>n>>>5e4fff2d0a992>5>http://r.iirose.com/i/20/1/2/5/5614-5G.jpg>>0向划过黑夜的流星许下心愿☄️>18609>2009>15,100,0.5
<cartoon/602178>2>小学>da9f9a>5fdcb9b634621>d>Bot of Koishi~\nPowered by IIROSE Adapter.>>679a67a46f713>>>a>4>2439>2>2,100,0.5'5b792977089e7>社区>32,32,32>000>>://r.iirose.com/i/21/5/21/20/3310-GX.jpg 为您提供各类系统服务&&IIROSE&&0&&system/900003&&1IMod&&&&&&>1,1536146146>1


//  下面是频道列表

<5b792c73178f2>住宅>32,32,32>000>>://r.iirose.com/i/21/5/21/20/3539-BG.jpg 对住宅区房产持有超过2栋的人征收物管费 , 收费标准为阶梯式 :\n  小于等于2栋 : 免物管费\n  大2栋 : 超过部分收取物管费 ,  超过一栋 8钞/日 , 超过两栋 10钞/日 , 超过三栋 12钞/日 , 假如我有5栋房计算方法为 : 超过部分为3栋,故此,8+10+12,也就是 30钞/日&&IIROSE&&0&&system/900003&&1IMod&&&&&&>1,1536146147>1
<5b792cb650749_690cc460936d3>君凌橙夏>0,0,0>2003>> &&君凌&&1&&http://r.iirose.com/i/25/10/19/12/4016-KC.jpg&&&&&&&&>1,1762444384>
<5b792cb650749_690eb5971454e>此世.彼世>0,0,0>0003>>://r.iirose.com/i/25/11/8/6/1212-PG.png &&无北先生&&0&&http://r.iirose.com/i/25/10/23/15/5042-X5.png&&&&&&&&>1,1762571671>
<5b792cb650749_690f30bc3d1d3>一日间>0,0,0>2003>2>://r.iirose.com/i/25/11/8/20/0333-7M.png &&Phosphophyllite&&0&&http://r.iirose.com/i/25/2/24/14/2941-GD.png&&1远浪&&&&&&>1,1762603196>
<5b792cb650749_61b25bb771a6b_690f3ff5c86e3>，，，>0,0,0>2003>> &&忽来&&0&&cartoon/602226&&&&&&&&>1,1762607093>

//  个人信息
\"小学>2>da9f9a>cartoon/602178>>>679a67a46f713>67adce1c79a05>>4>

//  下面是历史聊天记录
\"1762610384>cartoon/602178>小学>'3>s>da9f9a>2>>679a67a46f713>4''2439'2'2,100,0.5>>2
<1762609577>cartoon/602178>小学>'1>s>da9f9a>2>>679a67a46f713>4''2438'2'2,100,0.5>>15fdcb9b634621'd'Bot of Koishi~\nPowered by IIROSE Adapter.'''
<1762608775>cartoon/602178>小学>'3>s>da9f9a>2>>679a67a46f713>4''2438'2'2,100,0.5>>2
<1762607291>cartoon/602178>小学>啊呜， [*上学*] 下次再来哦~>ffffff>da9f9a>2>>679a67a46f713>4''2438'2'2,100,0.5>978519260699
<1762607281>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>'3>s>614530>2>>679a51f1d4893>''1908'60'2,100,0.5>>2
<1762605357>cartoon/602178>小学>'1>s>da9f9a>2>>679a67a46f713>4''2437'2'2,100,0.5>>15fdcb9b634621'd'Bot of Koishi~\nPowered by IIROSE Adapter.'''

//  下面是加载信息
\">>00 
<>&>10>>10,0>2>>>>"
```
