# 消息及相关交互报文

本文档详细说明了与 IIROSE 核心消息功能、以及由消息衍生出的各类交互相关的报文格式和解析逻辑。

## 核心消息

### 公屏消息

- **报文流向**: 客户端 `->` 服务器 (发送) / 服务器 `->` 客户端 (接收)

#### 发送格式
```log
{"m":"大家好啊，第一次来到IIROSE呢。","mc":"d28ad2","i":"585575973337"}
```

#### 接收格式
```log
"1762412858>cartoon/600264>anata baka？>大家好啊，第一次来到IIROSE呢。>d28ad2>d28ad2>2>>68af217fea585>''42'3'0,0,0.5>585575973337
```

### 私聊消息

- **报文流向**: 客户端 `->` 服务器 (发送) / 服务器 `->` 客户端 (接收)

#### 发送格式
```log
{"g":"679a67a46f713","m":"echo 你好啊，我回复你了","mc":"d28ad2","i":"297027795846"}
```

#### 接收格式
```log
""1762412931>679a67a46f713>小学>cartoon/602178>你好啊，我回复你了>ffffff>>da9f9a>2>>052718573488
```

### 广播消息 (弹幕)

> 发送广播消息需要绑定手机号。

- **报文流向**: 客户端 `->` 服务器 (发送) / 服务器 `->` 客户端 (接收)

#### 发送格式
```log
~{"t":"饿啊 测试广播消息","c":"614530","v":0}
```

#### 接收格式
```log
=上学>饿啊 测试广播消息>614530>614530>2>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>1762413398>679a51f1d4893>>1866>57>2,100,0.5>f160
```

---

## 消息交互

### 消息撤回

- **报文流向**: 客户端 `->` 服务器 (请求撤回) / 服务器 `->` 客户端 (广播撤回)

#### 发送格式 (请求撤回)
```log
v0#535908832441
```

#### 接收格式 (广播撤回)
```log
v0#679a51f1d4893_535908832441"
```

### 消息引用

> 引用一条消息的格式为 `被引用消息内容 (_hr) 发送者_消息ID (hr_) 新消息内容`。

#### 发送格式
```log
{"m":"第一条消息 (_hr) 上学_1762414014 (hr_) 第二条消息","mc":"614530","i":"193388427515"}
```

#### 接收格式
```log
"1762414019>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>第一条消息 (_hr) 上学_1762414014 (hr_) 第二条消息>614530>614530>2>>679a51f1d4893>''1866'57'2,100,0.5>193388427515
```

### 提及用户 (@)

> 提及用户的格式为 `[*用户名*]`。

#### 发送格式
```log
{"m":" [*小学*]  你好","mc":"614530","i":"231011249357"}
```

#### 接收格式
```log
"1762414122>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学> [*小学*]  你好>614530>614530>2>>679a51f1d4893>''1866'57'2,100,0.5>231011249357
```

### 提及频道

> 提及频道的格式为 `[_频道ID_]`。

#### 发送格式
```log
{"m":"我们这里是  [_5fdcb9b634621_]  ","mc":"614530","i":"532788685715"}
```

#### 接收格式
```log
"1762414153>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>我们这里是  [_5fdcb9b634621_]  >614530>614530>2>>679a51f1d4893>''1866'57'2,100,0.5>532788685715
```

---

## 特殊消息类型

### 匿名消息

> 虽然名为匿名，但服务器下发的数据中包含了发送者的真实信息，前端通过特殊处理实现了“匿名”的展示效果。

- **报文流向**: 客户端 `->` 服务器 (发送) / 服务器 `->` 客户端 (接收)

#### 发送格式
```log
{"g":"679a67a46f713","m":"你好","st":"@","i":"154935167557"}
```

#### 接收格式
```log
""1762413929>679a51f1d4893>上学>>你好>>@>>>>292047017691
```

### 媒体消息

#### 发送图片
> 图片可以直接使用URL，或使用 `[URL]`、`[URL#e]` 的格式。

##### 发送格式
```log
{"m":"http://r.iirose.com/i/25/10/6/2/2917-4W.png#e","mc":"614530","i":"703027225044"}
```

##### 接收格式
```log
"1762414470>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>http://r.iirose.com/i/25/10/6/2/2917-4W.png#e>614530>614530>2>>679a51f1d4893>''1867'57'2,100,0.5>703027225044
```

#### 发送语音
> 语音URL必须以 `.weba` 结尾。

##### 发送格式
```log
{"m":"http://r.iirose.com/s/25/11/6/15/3556-OL.weba","mc":"614530","i":"554554093356"}
```

##### 接收格式
```log
"1762414555>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>http://r.iirose.com/s/25/11/6/15/3556-OL.weba>614530>614530>2>>679a51f1d4893>''1867'57'2,100,0.5>554554093356
```

#### 发送视频
> 视频URL需要用 `[]` 包裹。

##### 发送格式
```log
{"m":"[http://r.iirose.com/m/25/11/1/17/0614-1U.mp4]","mc":"614530","i":"185967768146"}
```

##### 接收格式
```log
"1762414618>http://r.iirose.com/i/24/10/11/17/4017-4V.jpg>上学>[http://r.iirose.com/m/25/11/1/17/0614-1U.mp4]>614530>614530>2>>679a51f1d4893>''1867'57'2,100,0.5>185967768146
```

---

## 邮箱与用户动作

:::tip 提示
以下部分包含了大量**客户端主动发起**的动作，它们在功能上与用户交互更相关，但由于其报文格式与消息相似（通常是特定前缀+内容），因此在这里一并列出。
:::

### 邮箱消息 (被动接收)

> 当被点赞、收到站内信等时，会收到此类消息。

#### 接收格式 (被点赞)
```log
@*小学>cartoon/602178>2>'*>>1762413535>da9f9a
```

### 点赞/点踩 (主动发送)

#### 点赞
```log
+*68af217fea585
```

#### 点踩 (可附带备注)
```log
+!68af217fea585 这里是点踩备注
```

### 关注/取关 (主动发送)

#### 关注
```log
+#068af217fea585
```

#### 取消关注
```log
+#168af217fea585
```

### 转账 (主动发送)

#### 转账 (无备注)
```log
+${"g":"68af217fea585","c":10}
```

#### 转账 (有备注)
```log
+${"g":"68af217fea585","c":1,"m":"这里是备注"}
```

### 打分 (主动发送)

#### 为别人打分
```log
+_*68af217fea585 77
```

#### 删除对别人的打分
```log
+_*68af217fea585 !
